<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리반 화폐 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .keypad-btn { transition: all 0.1s ease-in-out; }
        .keypad-btn:active { transform: scale(0.95); background-color: #e0e0e0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader {
            border: 8px solid #f3f3f3; border-radius: 50%;
            border-top: 8px solid #3498db; width: 60px; height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl mx-auto">
        <!-- 로딩 화면 -->
        <div id="loading-screen" class="text-center p-6">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">데이터를 불러오는 중입니다...</p>
        </div>

        <!-- 로그인 화면 -->
        <div id="login-screen" class="hidden p-4 sm:p-6">
            <header class="text-center mb-6">
                <h1 id="header-title" class="text-3xl sm:text-4xl font-bold text-gray-800"></h1>
                <p class="text-gray-600 mt-2">자신의 캐릭터를 선택하고 비밀번호를 입력하세요.</p>
            </header>
            <div id="student-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- 학생 카드가 여기에 동적으로 추가됩니다. -->
            </div>
        </div>

        <!-- 개인 페이지 -->
        <div id="personal-page" class="hidden p-4 sm:p-6 bg-white rounded-2xl shadow-xl">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-6 pb-4 border-b">
                <div class="flex items-center space-x-4">
                    <img id="student-avatar-personal" src="" alt="학생 아바타" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-blue-400 object-cover">
                    <div>
                        <h2 id="student-nickname-personal" class="text-2xl sm:text-3xl font-bold text-gray-800"></h2>
                        <p class="text-lg text-blue-600 font-semibold"><span id="currency-label"></span>: <span id="total-clouds"></span>개</p>
                    </div>
                </div>
                <button id="logout-button" class="mt-4 sm:mt-0 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">로그아웃</button>
            </div>
            
            <h3 id="details-header" class="text-xl font-bold text-gray-700 mb-4"></h3>
            <div class="overflow-y-auto h-96 custom-scrollbar border rounded-lg">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3">날짜</th>
                            <th scope="col" class="px-4 py-3">내용</th>
                            <th scope="col" class="px-4 py-3 text-center">변동</th>
                            <th scope="col" class="px-4 py-3 text-center">남은 <span class="currency-name-span"></span></th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history">
                        <!-- 거래 내역이 여기에 동적으로 추가됩니다. -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 비밀번호 입력 모달 -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6 text-center">
            <img id="modal-avatar" src="" alt="아바타" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-gray-300 object-cover">
            <h3 id="modal-nickname" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p class="text-gray-600 mb-4">비밀번호를 입력하세요.</p>
            <div id="password-display" class="bg-gray-200 w-full h-12 rounded-lg text-3xl flex items-center justify-center tracking-widest mb-4"></div>
            <p id="error-message" class="text-red-500 h-5 mb-2 text-sm"></p>
            <div class="grid grid-cols-3 gap-2">
                <!-- 숫자 키패드가 여기에 동적으로 추가됩니다. -->
            </div>
            <div class="mt-4 flex gap-2">
                <button id="close-modal-button" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition">취소</button>
                <button id="login-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">확인</button>
            </div>
        </div>
    </div>

    <script>
        // --- 설정 ---
        // 1. 안내서에 따라 '학생명단'과 '화폐내역' 시트의 CSV 게시 링크를 아래에 각각 붙여넣으세요.
        const STUDENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZ_ShFIM2PJKekYJR4hZr4xdTAvhD-3O27pYsSiY5wh43xx7QSS0RV2rYkcqzfJGA7hegjwaRNs2Vg/pub?gid=0&single=true&output=csv';
        const TRANSACTIONS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZ_ShFIM2PJKekYJR4hZr4xdTAvhD-3O27pYsSiY5wh43xx7QSS0RV2rYkcqzfJGA7hegjwaRNs2Vg/pub?gid=1883191849&single=true&output=csv';

        // 2. 학급 화폐 이름을 원하는 대로 수정하세요. (예: '보석', '칭찬별')
        const CURRENCY_NAME = '구름';
        // --- 설정 끝 ---

        // HTML 요소 가져오기
        const loadingScreen = document.getElementById('loading-screen');
        const loginScreen = document.getElementById('login-screen');
        const personalPage = document.getElementById('personal-page');
        const studentGrid = document.getElementById('student-grid');
        const passwordModal = document.getElementById('password-modal');
        
        // 전역 변수 선언
        let allStudents = [];
        let allTransactions = [];
        let currentStudent = null;
        let passwordInput = '';

        // 앱 초기화 함수
        window.onload = async function initializeApp() {
            updateUiText(); // 화폐 이름 등 UI 텍스트 업데이트

            if (STUDENTS_CSV_URL.includes('여기에') || TRANSACTIONS_CSV_URL.includes('여기에')) {
                loadingScreen.innerHTML = '<p class="text-red-500 font-bold">오류: index.html 파일에 구글 시트 URL을 먼저 입력해주세요.</p>';
                return;
            }
            try {
                const [studentData, transactionData] = await Promise.all([
                    fetchAndParseCsv(STUDENTS_CSV_URL),
                    fetchAndParseCsv(TRANSACTIONS_CSV_URL)
                ]);
                allStudents = studentData;
                allTransactions = transactionData;
                populateLoginScreen();
                loadingScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            } catch (error) {
                console.error("Data loading failed:", error);
                loadingScreen.innerHTML = `<p class="text-red-500 font-bold">데이터 로딩 실패.<br>구글 시트 '웹에 게시' 설정과 URL을 확인해주세요.</p>`;
            }
        }

        // UI에 표시되는 텍스트를 설정값에 따라 업데이트하는 함수
        function updateUiText() {
            document.title = `우리반 ${CURRENCY_NAME} 관리`;
            document.getElementById('header-title').textContent = `우리반 ${CURRENCY_NAME} 확인하기`;
            document.getElementById('currency-label').textContent = `현재 ${CURRENCY_NAME}`;
            document.getElementById('details-header').textContent = `상세 ${CURRENCY_NAME} 내역`;
            document.querySelectorAll('.currency-name-span').forEach(el => el.textContent = CURRENCY_NAME);
        }

        // CSV 데이터를 가져와 파싱하는 함수
        function fetchAndParseCsv(url) {
            const urlWithNoCache = `${url}?t=${new Date().getTime()}`;
            return new Promise((resolve, reject) => {
                Papa.parse(urlWithNoCache, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        // 로그인 화면에 학생 카드들을 채우는 함수
        function populateLoginScreen() {
            studentGrid.innerHTML = '';
            allStudents.forEach(student => {
                if (!student['별명'] || !student['이미지 주소']) return;
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-md text-center cursor-pointer hover:shadow-lg hover:scale-105 transition-transform';
                card.innerHTML = `
                    <img src="${student['이미지 주소']}" alt="${student['별명']}" class="w-24 h-24 rounded-full mx-auto mb-3 border-4 border-gray-200 object-cover" onerror="this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=%3F'">
                    <h3 class="font-bold text-gray-800">${student['별명']}</h3>
                `;
                card.addEventListener('click', () => { currentStudent = student; openPasswordModal(student); });
                studentGrid.appendChild(card);
            });
        }
        
        // 개인 페이지에 학생 정보와 거래 내역을 채우는 함수
        function populatePersonalPage(student) {
            document.getElementById('student-avatar-personal').src = student['이미지 주소'];
            document.getElementById('student-nickname-personal').textContent = student['별명'];
            const historyBody = document.getElementById('transaction-history');
            historyBody.innerHTML = '';
            const studentTransactions = allTransactions.filter(tx => tx['별명'] === student['별명']);

            if (studentTransactions.length === 0) {
                document.getElementById('total-clouds').textContent = '0';
                historyBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">${CURRENCY_NAME} 내역이 없습니다.</td></tr>`;
                return;
            }

            let runningTotal = 0;
            studentTransactions.forEach(tx => {
                const amount = parseInt(tx['변동'], 10) || 0;
                runningTotal += amount;
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const amountColor = amount >= 0 ? 'text-blue-600' : 'text-red-600';
                const amountPrefix = amount > 0 ? '+' : '';
                row.innerHTML = `
                    <td class="px-4 py-3">${tx['날짜']}</td>
                    <td class="px-4 py-3 font-medium text-gray-900">${tx['내용']}</td>
                    <td class="px-4 py-3 text-center font-semibold ${amountColor}">${amountPrefix}${amount}</td>
                    <td class="px-4 py-3 text-center font-bold">${runningTotal}</td>
                `;
                historyBody.appendChild(row);
            });
            document.getElementById('total-clouds').textContent = runningTotal;
        }
        
        // 화면 전환 함수
        function showLoginScreen() { loginScreen.classList.remove('hidden'); personalPage.classList.add('hidden'); currentStudent = null; }
        function showPersonalPage(student) { loginScreen.classList.add('hidden'); personalPage.classList.remove('hidden'); populatePersonalPage(student); }
        
        // 비밀번호 모달 관련 함수
        function openPasswordModal(student) {
            passwordInput = '';
            document.getElementById('modal-avatar').src = student['이미지 주소'];
            document.getElementById('modal-nickname').textContent = student['별명'];
            updatePasswordDisplay();
            document.getElementById('error-message').textContent = '';
            passwordModal.classList.remove('hidden');
        }
        function closePasswordModal() { passwordModal.classList.add('hidden'); }

        // 이벤트 리스너 연결
        document.getElementById('close-modal-button').addEventListener('click', closePasswordModal);
        document.getElementById('logout-button').addEventListener('click', showLoginScreen);
        document.getElementById('login-button').addEventListener('click', () => {
            if (passwordInput === currentStudent['비밀번호']) {
                closePasswordModal();
                showPersonalPage(currentStudent);
            } else {
                document.getElementById('error-message').textContent = '비밀번호가 틀렸어요!';
                passwordInput = '';
                updatePasswordDisplay();
            }
        });

        // --- 키패드 생성 및 로직 ---
        function handleKeypadClick(num) { if (passwordInput.length < 10) { passwordInput += num; updatePasswordDisplay(); } }
        function handleDeleteClick() { passwordInput = passwordInput.slice(0, -1); updatePasswordDisplay(); }
        function updatePasswordDisplay() { document.getElementById('password-display').textContent = '•'.repeat(passwordInput.length); }
        const keypadContainer = passwordModal.querySelector('.grid');
        if (keypadContainer.children.length === 0) {
            const keys = [1, 2, 3, 4, 5, 6, 7, 8, 9, ' ', 0, '⌫'];
            keys.forEach(key => {
                if (key === ' ') { keypadContainer.innerHTML += '<div></div>'; return; }
                const button = document.createElement('button');
                button.textContent = key;
                button.className = 'keypad-btn bg-gray-200 text-2xl font-bold p-4 rounded-lg';
                if(key === '⌫') { button.addEventListener('click', handleDeleteClick); } 
                else { button.addEventListener('click', () => handleKeypadClick(key)); }
                keypadContainer.appendChild(button);
            });
        }
    </script>
</body>
</html>

